/*
Copyright (c) 2003-2011, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){var a=CKEDITOR.htmlParser.fragment.prototype,b=CKEDITOR.htmlParser.element.prototype;a.onlyChild=b.onlyChild=function(){var a=this.children,b=a.length,c=b==1&&a[0];return c||null},b.removeAnyChildWithName=function(a){var b=this.children,c=[],d;for(var e=0;e<b.length;e++){d=b[e];if(!d.name)continue;d.name==a&&(c.push(d),b.splice(e--,1)),c=c.concat(d.removeAnyChildWithName(a))}return c},b.getAncestor=function(a){var b=this.parent;while(b&&(!b.name||!b.name.match(a)))b=b.parent;return b},a.firstChild=b.firstChild=function(a){var b;for(var c=0;c<this.children.length;c++){b=this.children[c];if(a(b))return b;if(b.name){b=b.firstChild(a);if(b)return b}}return null},b.addStyle=function(a,b,c){var d=this,e,f="";if(typeof b=="string")f+=a+":"+b+";";else{if(typeof a=="object")for(var g in a)a.hasOwnProperty(g)&&(f+=g+":"+a[g]+";");else f+=a;c=b}d.attributes||(d.attributes={}),e=d.attributes.style||"",e=(c?[f,e]:[e,f]).join(";"),d.attributes.style=e.replace(/^;|;(?=;)/,"")},CKEDITOR.dtd.parentOf=function(a){var b={};for(var c in this)c.indexOf("$")==-1&&this[c][a]&&(b[c]=1);return b};var c=/^([.\d]*)+(em|ex|px|gd|rem|vw|vh|vm|ch|mm|cm|in|pt|pc|deg|rad|ms|s|hz|khz){1}?/i,d=/^(?:\b0[^\s]*\s*){1,4}$/,e="^m{0,4}(cm|cd|d?c{0,3})(xc|xl|l?x{0,3})(ix|iv|v?i{0,3})$",f=new RegExp(e),g=new RegExp(e.toUpperCase()),h=0,i;CKEDITOR.plugins.pastefromword={utils:{createListBulletMarker:function(a,b){var c=new CKEDITOR.htmlParser.element("cke:listbullet"),d;return a?a[2]?(isNaN(a[1])?f.test(a[1])?a="lower-roman":g.test(a[1])?a="upper-roman":/^[a-z]+$/.test(a[1])?a="lower-alpha":/^[A-Z]+$/.test(a[1])?a="upper-alpha":a="decimal":a="decimal",d="ol"):(/[l\u00B7\u2002]/.test(a[1])?a="disc":/[\u006F\u00D8]/.test(a[1])?a="circle":/[\u006E\u25C6]/.test(a[1])?a="square":a="disc",d="ul"):(a="decimal",d="ol"),c.attributes={"cke:listtype":d,style:"list-style-type:"+a+";"},c.add(new CKEDITOR.htmlParser.text(b)),c},isListBulletIndicator:function(a){var b=a.attributes&&a.attributes.style;if(/mso-list\s*:\s*Ignore/i.test(b))return!0},isContainingOnlySpaces:function(a){var b;return(b=a.onlyChild())&&/^(:?\s|&nbsp;)+$/.test(b.value)},resolveList:function(a){var b=a.attributes,c;if((c=a.removeAnyChildWithName("cke:listbullet"))&&c.length&&(c=c[0])){a.name="cke:li",b.style&&(b.style=CKEDITOR.plugins.pastefromword.filters.stylesFilter([["text-indent"],["line-height"],[/^margin(:?-left)?$/,null,function(a){var c=a.split(" ");a=CKEDITOR.plugins.pastefromword.utils.convertToPx(c[3]||c[1]||c[0]),a=parseInt(a,10),!h&&i&&a>i&&(h=a-i),b["cke:margin"]=i=a}]])(b.style,a)||"");var d=c.attributes,e=d.style;return a.addStyle(e),CKEDITOR.tools.extend(b,d),!0}return!1},convertToPx:function(){var a=CKEDITOR.dom.element.createFromHtml('<div style="position:absolute;left:-9999px;top:-9999px;margin:0px;padding:0px;border:0px;"></div>',CKEDITOR.document);return CKEDITOR.document.getBody().append(a),function(b){return c.test(b)?(a.setStyle("width",b),a.$.clientWidth+"px"):b}}(),getStyleComponents:function(){var a=CKEDITOR.dom.element.createFromHtml('<div style="position:absolute;left:-9999px;top:-9999px;"></div>',CKEDITOR.document);return CKEDITOR.document.getBody().append(a),function(b,c,d){a.setStyle(b,c);var e={},f=d.length;for(var g=0;g<f;g++)e[d[g]]=a.getStyle(d[g]);return e}}(),listDtdParents:CKEDITOR.dtd.parentOf("ol")},filters:{flattenList:function(a){var b=a.attributes,c=a.parent,d,e=1;while(c)c.attributes&&c.attributes["cke:list"]&&e++,c=c.parent;switch(b.type){case"a":d="lower-alpha"}var f=a.children,g;for(var h=0;h<f.length;h++){g=f[h];var j=g.attributes;if(g.name in CKEDITOR.dtd.$listItem){var k=g.children,l=k.length,m=k[l-1];m.name in CKEDITOR.dtd.$list&&(f.splice(h+1,0,m),m.parent=a,--k.length||f.splice(h,1)),g.name="cke:li",j["cke:indent"]=e,i=0,j["cke:listtype"]=a.name,d&&g.addStyle("list-style-type",d,!0)}}delete a.name,b["cke:list"]=1},assembleList:function(a){var b=a.children,c,d,e,f,g,i,j,k,l;for(var m=0;m<b.length;m++){c=b[m];if("cke:li"==c.name){c.name="li",d=c,e=d.attributes,f=d.attributes["cke:listtype"],g=parseInt(e["cke:indent"],10)||h&&Math.ceil(e["cke:margin"]/h)||1,e.style&&(e.style=CKEDITOR.plugins.pastefromword.filters.stylesFilter([["list-style-type",f=="ol"?"decimal":"disc"]])(e.style)||"");if(!j)j=new CKEDITOR.htmlParser.element(f),j.add(d),b[m]=j;else{if(g>l)j=new CKEDITOR.htmlParser.element(f),j.add(d),i.add(j);else if(g<l){var n=l-g,o;while(n--&&(o=j.parent))j=o.parent;j.add(d)}else j.add(d);b.splice(m--,1)}i=d,l=g}else j=null}h=0},falsyFilter:function(a){return!1},stylesFilter:function(a,b){return function(c,d){var e=[];c.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(c,f,g){f=f.toLowerCase(),f=="font-family"&&(g=g.replace(/["']/g,""));var h,i,j,m;for(var p=0;p<a.length;p++)if(a[p]){h=a[p][0],i=a[p][1],j=a[p][2],m=a[p][3];if(f.match(h)&&(!i||g.match(i))){f=m||f,b&&(j=j||g),typeof j=="function"&&(j=j(g,d,f)),j&&j.push&&(f=j[0],j=j[1]),typeof j=="string"&&e.push([f,j]);return}}!b&&e.push([f,g])});for(var f=0;f<e.length;f++)e[f]=e[f].join(":");return e.length?e.join(";")+";":!1}},elementMigrateFilter:function(a,b){return function(c){var d=b?(new CKEDITOR.style(a,b))._.definition:a;c.name=d.element,CKEDITOR.tools.extend(c.attributes,CKEDITOR.tools.clone(d.attributes)),c.addStyle(CKEDITOR.style.getStyleText(d))}},styleMigrateFilter:function(a,b){var c=this.elementMigrateFilter;return function(d,e){var f=new CKEDITOR.htmlParser.element(null),g={};g[b]=d,c(a,g)(f),f.children=e.children,e.children=[f]}},bogusAttrFilter:function(a,b){if(b.name.indexOf("cke:")==-1)return!1},applyStyleFilter:null},getRules:function(a){var b=CKEDITOR.dtd,c=CKEDITOR.tools.extend({},b.$block,b.$listItem,b.$tableContent),e=a.config,f=this.filters,g=f.falsyFilter,h=f.stylesFilter,i=f.elementMigrateFilter,j=CKEDITOR.tools.bind(this.filters.styleMigrateFilter,this.filters),k=this.utils.createListBulletMarker,l=f.flattenList,m=f.assembleList,n=this.utils.isListBulletIndicator,o=this.utils.isContainingOnlySpaces,p=this.utils.resolveList,q=this.utils.convertToPx,r=this.utils.getStyleComponents,s=this.utils.listDtdParents,t=e.pasteFromWordRemoveFontStyles!==!1,u=e.pasteFromWordRemoveStyles!==!1;return{elementNames:[[/meta|link|script/,""]],root:function(a){a.filterChildren(),m(a)},elements:{"^":function(a){var b;CKEDITOR.env.gecko&&(b=f.applyStyleFilter)&&b(a)},$:function(a){var d=a.name||"",f=a.attributes;d in c&&f.style&&(f.style=h([[/^(:?width|height)$/,null,q]])(f.style)||"");if(d.match(/h\d/)){a.filterChildren();if(p(a))return;i(e["format_"+d])(a)}else if(d in b.$inline)a.filterChildren(),o(a)&&delete a.name;else if(d.indexOf(":")!=-1&&d.indexOf("cke")==-1){a.filterChildren();if(d=="v:imagedata"){var g=a.attributes["o:href"];g&&(a.attributes.src=g),a.name="img";return}delete a.name}d in s&&(a.filterChildren(),m(a))},style:function(a){if(CKEDITOR.env.gecko){var b=a.onlyChild().value.match(/\/\* Style Definitions \*\/([\s\S]*?)\/\*/),c=b&&b[1],d={};c&&(c.replace(/[\n\r]/g,"").replace(/(.+?)\{(.+?)\}/g,function(a,b,c){b=b.split(",");var e=b.length,f;for(var g=0;g<e;g++)CKEDITOR.tools.trim(b[g]).replace(/^(\w+)(\.[\w-]+)?$/g,function(a,b,e){b=b||"*",e=e.substring(1,e.length);if(e.match(/MsoNormal/))return;d[b]||(d[b]={}),e?d[b][e]=c:d[b]=c})}),f.applyStyleFilter=function(a){var b=d["*"]?"*":a.name,c=a.attributes&&a.attributes["class"],e;b in d&&(e=d[b],typeof e=="object"&&(e=e[c]),e&&a.addStyle(e,!0))})}return!1},p:function(a){a.filterChildren();if(p(a))return;e.enterMode==CKEDITOR.ENTER_BR?(delete a.name,a.add(new CKEDITOR.htmlParser.element("br"))):i(e["format_"+(e.enterMode==CKEDITOR.ENTER_P?"p":"div")])(a)},div:function(a){var b=a.onlyChild();if(b&&b.name=="table"){var c=a.attributes;b.attributes=CKEDITOR.tools.extend(b.attributes,c),c.style&&b.addStyle(c.style);var d=new CKEDITOR.htmlParser.element("div");d.addStyle("clear","both"),a.add(d),delete a.name}},td:function(a){a.getAncestor("thead")&&(a.name="th")},ol:l,ul:l,dl:l,font:function(a){if(!CKEDITOR.env.gecko&&n(a.parent)){delete a.name;return}a.filterChildren();var b=a.attributes,c=b.style,d=a.parent;"font"==d.name?(CKEDITOR.tools.extend(d.attributes,a.attributes),c&&d.addStyle(c),delete a.name):(c=c||"",b.color&&(b.color!="#000000"&&(c+="color:"+b.color+";"),delete b.color),b.face&&(c+="font-family:"+b.face+";",delete b.face),b.size&&(c+="font-size:"+(b.size>3?"large":b.size<3?"small":"medium")+";",delete b.size),a.name="span",a.addStyle(c))},span:function(a){if(!CKEDITOR.env.gecko&&n(a.parent))return!1;a.filterChildren();if(o(a))return delete a.name,null;if(!CKEDITOR.env.gecko&&n(a)){var b=a.firstChild(function(a){return a.value||a.name=="img"}),c=b&&(b.value||"l."),d=c.match(/^([^\s]+?)([.)]?)$/);return k(d,c)}var f=a.children,g=a.attributes,i=g&&g.style,l=f&&f[0];return i&&(g.style=h([["line-height"],[/^font-family$/,null,t?null:j(e.font_style,"family")],[/^font-size$/,null,t?null:j(e.fontSize_style,"size")],[/^color$/,null,t?null:j(e.colorButton_foreStyle,"color")],[/^background-color$/,null,t?null:j(e.colorButton_backStyle,"color")]])(i,a)||""),null},b:i(e.coreStyles_bold),i:i(e.coreStyles_italic),u:i(e.coreStyles_underline),s:i(e.coreStyles_strike),sup:i(e.coreStyles_superscript),sub:i(e.coreStyles_subscript),a:function(a){var b=a.attributes;b&&!b.href&&b.name&&delete a.name},"cke:listbullet":function(a){a.getAncestor(/h\d/)&&!e.pasteFromWordNumberedHeadingToList&&delete a.name}},attributeNames:[[/^onmouse(:?out|over)/,""],[/^onload$/,""],[/(?:v|o):\w+/,""],[/^lang/,""]],attributes:{style:h(u?[[/^margin$|^margin-(?!bottom|top)/,null,function(a,b,c){if(b.name in{p:1,div:1}){var f=e.contentsLangDirection=="ltr"?"margin-left":"margin-right";if(c=="margin")a=r(c,a,[f])[f];else if(c!=f)return null;if(a&&!d.test(a))return[f,a]}return null}],[/^clear$/],[/^border.*|margin.*|vertical-align|float$/,null,function(a,b){if(b.name=="img")return a}],[/^width|height$/,null,function(a,b){if(b.name in{table:1,td:1,th:1,img:1})return a}]]:[[/^mso-/],[/-color$/,null,function(a){if(a=="transparent")return!1;if(CKEDITOR.env.gecko)return a.replace(/-moz-use-text-color/g,"transparent")}],[/^margin$/,d],["text-indent","0cm"],["page-break-before"],["tab-stops"],["display","none"],t?[/font-?/]:null],u),width:function(a,c){if(c.name in b.$tableContent)return!1},border:function(a,c){if(c.name in b.$tableContent)return!1},"class":g,bgcolor:g,valign:u?g:function(a,b){return b.addStyle("vertical-align",a),!1}},comment:CKEDITOR.env.ie?g:function(a,b){var c=a.match(/<img.*?>/),d=a.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/);if(d){var e=d[1]||c&&"l.",f=e&&e.match(/>([^\s]+?)([.)]?)</);return k(f,e)}if(CKEDITOR.env.gecko&&c){var g=CKEDITOR.htmlParser.fragment.fromHtml(c[0]).children[0],h=b.previous,i=h&&h.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/),j=i&&i[1];return j&&(g.attributes.src=j),g}return!1}}}};var j=function(){this.dataFilter=new CKEDITOR.htmlParser.filter};j.prototype={toHtml:function(a){var b=CKEDITOR.htmlParser.fragment.fromHtml(a,!1),c=new CKEDITOR.htmlParser.basicWriter;return b.writeHtml(c,this.dataFilter),c.getHtml(!0)}},CKEDITOR.cleanWord=function(a,b){CKEDITOR.env.gecko&&(a=a.replace(/(<!--\[if[^<]*?\])-->([\S\s]*?)<!--(\[endif\]-->)/gi,"$1$2$3"));var c=new j,d=c.dataFilter;d.addRules(CKEDITOR.plugins.pastefromword.getRules(b)),b.fire("beforeCleanWord",{filter:d});try{a=c.toHtml(a,!1)}catch(e){alert(b.lang.pastefromword.error)}return a=a.replace(/cke:.*?".*?"/g,""),a=a.replace(/style=""/g,""),a=a.replace(/<span>/g,""),a}})()